<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSM | Conc SiTEF Premium</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22none%22 stroke=%22%233b82f6%22 stroke-width=%225%22/><text y=%2250%%22 x=%2250%%22 font-size=%2255%22 fill=%22%233b82f6%22 font-family=%22Arial%22 font-weight=%22900%22 text-anchor=%22middle%22 dy=%22.35em%22 style=%22text-shadow: 0 0 10px %233b82f6;%22>V</text></svg>">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #020203;
            --card-dark: #0a0a0c;
            --accent-blue: #3b82f6;
            --accent-neon: #00ff9d;
            --accent-red: #ff4757;
            --text-primary: #ffffff;
            --text-secondary: #71717a;
            --border: rgba(255, 255, 255, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ANIMAÃ‡Ã•ES DE BRILHO */
        @keyframes logoGlow {
            0% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); border-color: rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.7); border-color: var(--accent-blue); }
            100% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); border-color: rgba(59, 130, 246, 0.4); }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-primary); 
            min-height: 100vh; 
            background-image: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 40%),
                              radial-gradient(circle at 80% 80%, rgba(0, 255, 157, 0.03) 0%, transparent 40%);
        }

        /* TELA DE LOGIN */
        #welcome-screen {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            background-image: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            transition: opacity 0.8s ease;
        }
        .login-box { text-align: center; width: 100%; max-width: 400px; padding: 40px; }

        /* HEADER E LOGO */
        .wrapper { max-width: 1440px; margin: 0 auto; padding: 40px; display: none; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 50px; padding-bottom: 25px; border-bottom: 1px solid var(--border); }
        
        .logo-icon { 
            width: 52px; height: 52px; background: rgba(59, 130, 246, 0.1); 
            border: 1.5px solid rgba(59, 130, 246, 0.4); border-radius: 14px; 
            display: flex; align-items: center; justify-content: center; 
            animation: logoGlow 3s infinite ease-in-out; margin-right: 20px;
        }
        .logo-icon::after { content: 'V'; font-weight: 800; color: #fff; font-size: 1.8rem; text-shadow: 0 0 10px var(--accent-blue); }

        /* KPI CARDS COM BRILHO */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { 
            background: var(--card-dark); border: 1px solid var(--border); 
            border-radius: 24px; padding: 24px; transition: var(--transition);
        }
        .kpi-card:hover { border-color: var(--accent-blue); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .kpi-card label { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; }
        .kpi-card .number { font-size: 2.8rem; font-weight: 800; margin-top: 10px; }
        
        .kpi-card.divergent-highlight { border-color: rgba(255, 71, 87, 0.2); }
        .kpi-card.divergent-highlight .number { color: var(--accent-red); text-shadow: 0 0 20px rgba(255, 71, 87, 0.3); }

        /* BARRA DE FILTRO E PESQUISA */
        .filter-bar { 
            display: flex; gap: 12px; margin-bottom: 20px; 
            background: var(--card-dark); padding: 12px; 
            border-radius: 18px; border: 1px solid var(--border); 
            align-items: center;
        }
        .search-input { 
            flex: 1; background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); padding: 12px 20px; 
            border-radius: 12px; color: white; outline: none; transition: var(--transition);
        }
        .search-input:focus { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.05); }

        .filter-btn { 
            padding: 10px 24px; border-radius: 12px; 
            border: 1px solid var(--border); background: transparent; 
            color: var(--text-secondary); cursor: pointer; font-weight: 700; transition: var(--transition);
        }
        .filter-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        /* UPLOAD AREA */
        .upload-area { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px; }
        .drop-box { 
            background: var(--card-dark); border: 1px solid var(--border); 
            border-radius: 20px; padding: 35px; transition: var(--transition);
        }
        .drop-box.success { border-color: var(--accent-neon); box-shadow: 0 0 20px rgba(0, 255, 157, 0.1); }

        /* TABELA */
        .data-section { background: var(--card-dark); border: 1px solid var(--border); border-radius: 24px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 22px; background: rgba(255,255,255,0.02); text-align: left; color: var(--text-secondary); font-size: 0.75rem; border-bottom: 1px solid var(--border); }
        td { padding: 18px 22px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        
        .status-tag { padding: 6px 14px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .tag-active { background: rgba(0, 255, 157, 0.1); color: var(--accent-neon); border: 1px solid rgba(0, 255, 157, 0.2); }
        .tag-error { background: rgba(255, 71, 87, 0.1); color: var(--accent-red); border: 1px solid rgba(255, 71, 87, 0.2); }

        .btn-action { 
            background: var(--accent-blue); color: white; border: none; 
            padding: 14px 28px; border-radius: 14px; font-weight: 700; cursor: pointer; transition: var(--transition);
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
    </style>
</head>
<body>

<div id="welcome-screen">
    <div class="login-box">
        <div class="logo-icon" style="margin: 0 auto 30px; width: 80px; height: 80px;"></div>
        <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 10px;">VSM <span style="color:var(--accent-blue)">Conciliador</span></h1>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">Auditoria Inteligente Software Express</p>
        <input type="text" id="userName" class="search-input" style="text-align: center; margin-bottom: 20px;" placeholder="Digite seu nome">
        <button class="btn-action" style="width: 100%;" onclick="startSession()">ENTRAR NO PAINEL</button>
    </div>
</div>

<div class="wrapper" id="main-app">
    <header>
        <div style="display: flex; align-items: center;">
            <div class="logo-icon"></div>
            <div class="brand-text">
                <h1>VSM<span>.INFO</span></h1>
                <p style="color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 3px; font-weight: 600;">OPERADOR: <span id="userDisplay" style="color: var(--accent-blue)">-</span></p>
            </div>
        </div>
        <div style="display:flex; gap:12px;">
            <button class="btn-action" id="exportBtn" style="display:none" onclick="exportExcel()">EXPORTAR RELATÃ“RIO</button>
            <button class="btn-action" style="background:transparent; border:1px solid #333; color: #888;" onclick="logout()">SAIR</button>
        </div>
    </header>

    <div class="upload-area">
        <div class="drop-box" id="upSist">
            <h3 style="font-size: 0.7rem; color: var(--accent-blue); letter-spacing: 2px;">PASSO 01</h3>
            <h2 id="statusMetabase">METABASE SQL</h2>
            <p id="txtSist" style="font-size: 0.85rem; color: var(--text-secondary);">Sincronizando base...</p>
        </div>
        <div class="drop-box" id="upPlan" onclick="document.getElementById('inPlan').click()" style="cursor: pointer;">
            <h3 style="font-size: 0.7rem; color: var(--accent-blue); letter-spacing: 2px;">PASSO 02</h3>
            <h2>SOFTWARE EXPRESS</h2>
            <p id="txtPlan" style="font-size: 0.85rem; color: var(--text-secondary);">Clique para importar faturamento (.xlsx)</p>
            <input type="file" id="inPlan" hidden accept=".xlsx, .xls">
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card"><label>Total Analisado</label><div class="number" id="kTotal">0</div></div>
        <div class="kpi-card"><label>Em Conformidade</label><div class="number" id="kOk" style="color:var(--accent-neon)">0</div></div>
        <div class="kpi-card divergent-highlight"><label>DivergÃªncias</label><div class="number" id="kDiv">0</div></div>
        <div class="kpi-card"><label>Acuracidade</label><div class="number" id="kHealth" style="color:var(--accent-blue)">--</div></div>
    </div>

    <div class="filter-bar" id="filterBar" style="display:none;">
        <input type="text" class="search-input" id="searchInput" placeholder="ðŸ” Pesquisar por nome da loja ou CNPJ..." onkeyup="applyFilters()">
        <div style="display:flex; gap:8px;">
            <button class="filter-btn active" id="btnAll" onclick="setFilter('all')">Todos</button>
            <button class="filter-btn" id="btnDiv" onclick="setFilter('div')">Divergentes</button>
        </div>
    </div>

    <div class="data-section">
        <table>
            <thead>
                <tr>
                    <th>CNPJ MERCHANT</th>
                    <th>NOME DA UNIDADE / LOJA</th>
                    <th>STATUS SE</th>
                    <th>STATUS VSM</th>
                    <th>DIAGNÃ“STICO</th>
                </tr>
            </thead>
            <tbody id="mainTable">
                <tr><td colspan="5" style="text-align:center; padding:80px; color:var(--text-secondary);">AGUARDANDO IMPORTAÃ‡ÃƒO DO PASSO 02...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let dbSist = new Set();
    let dbPlan = [];
    let currentFilter = 'all';
    const METABASE_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent("http://dashboard.vsm.com.br/public/question/939a350b-4326-409e-ba67-aeb625626dd1.csv");

    function startSession() {
        const name = document.getElementById('userName').value;
        if(!name) return alert("Por favor, informe seu nome.");
        localStorage.setItem('vsm_user', name);
        showDashboard(name);
    }

    function showDashboard(name) {
        document.getElementById('userDisplay').innerText = name.toUpperCase();
        document.getElementById('welcome-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
        }, 800);
    }

    async function fetchMetabase() {
        try {
            const resp = await fetch(METABASE_URL);
            const csv = await resp.text();
            const rows = csv.split('\n').slice(1);
            dbSist.clear();
            rows.forEach(row => {
                const cnpj = row.split(',')[0].replace(/\D/g, '').trim();
                if(cnpj) dbSist.add(cnpj);
            });
            document.getElementById('upSist').classList.add('success');
            document.getElementById('txtSist').innerHTML = `<b style="color:var(--accent-neon)">âœ“ ${dbSist.size} CNPJs SINCRONIZADOS</b>`;
            if(dbPlan.length > 0) applyFilters();
        } catch (e) {
            document.getElementById('txtSist').innerText = "ERRO DE CONEXÃƒO SQL";
        }
    }

    document.getElementById('inPlan').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const wb = XLSX.read(evt.target.result, {type: 'binary'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws);
            dbPlan = [];
            data.forEach(row => {
                const cnpjKey = Object.keys(row).find(k => k.toLowerCase().includes('cnpj') && k.toLowerCase().includes('loja'));
                const nomeKey = Object.keys(row).find(k => k.toLowerCase().includes('nome') && k.toLowerCase().includes('loja'));
                const valorKey = Object.keys(row).find(k => k.toLowerCase().includes('total') && k.toLowerCase().includes('cobr'));

                if (cnpjKey && row[cnpjKey]) {
                    const cnpjLimpo = String(row[cnpjKey]).replace(/\D/g, '');
                    const valor = parseFloat(String(row[valorKey] || 0).replace(',', '.'));
                    if (cnpjLimpo.length === 14 && cnpjLimpo !== "55649404000283" && valor > 0) {
                        dbPlan.push({ cnpj: cnpjLimpo, nome: (row[nomeKey] || "NÃƒO IDENTIFICADO").toUpperCase() });
                    }
                }
            });
            localStorage.setItem('vsm_conc_data', JSON.stringify(dbPlan));
            document.getElementById('upPlan').classList.add('success');
            document.getElementById('txtPlan').innerHTML = `<b style="color:var(--accent-neon)">âœ“ ${dbPlan.length} LOJAS IMPORTADAS</b>`;
            document.getElementById('filterBar').style.display = 'flex';
            document.getElementById('exportBtn').style.display = "block";
            applyFilters();
        };
        reader.readAsBinaryString(e.target.files[0]);
    };

    function setFilter(type) {
        currentFilter = type;
        document.getElementById('btnAll').classList.toggle('active', type === 'all');
        document.getElementById('btnDiv').classList.toggle('active', type === 'div');
        applyFilters();
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const tbody = document.getElementById('mainTable');
        tbody.innerHTML = "";
        
        const filtered = dbPlan.filter(item => {
            const hasStatus = dbSist.has(item.cnpj);
            const matchesSearch = item.nome.toLowerCase().includes(searchTerm) || item.cnpj.includes(searchTerm);
            const matchesStatus = currentFilter === 'all' || (currentFilter === 'div' && !hasStatus);
            return matchesSearch && matchesStatus;
        });

        filtered.forEach(item => {
            const status = dbSist.has(item.cnpj);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-family:'JetBrains Mono'; color:var(--accent-blue)">${item.cnpj}</td>
                <td style="font-weight:700">${item.nome}</td>
                <td><span class="status-tag tag-active">ATIVO</span></td>
                <td><span class="status-tag ${status ? 'tag-active' : 'tag-error'}">${status ? 'ATIVO' : 'TERMINATED'}</span></td>
                <td style="font-weight:800; color:${status ? 'var(--accent-neon)' : 'var(--accent-red)'}">${status ? 'OK' : 'DIVERGENTE'}</td>
            `;
            tbody.appendChild(tr);
        });
        updateKPIs();
    }

    function updateKPIs() {
        const ok = dbPlan.filter(i => dbSist.has(i.cnpj)).length;
        const total = dbPlan.length;
        document.getElementById('kTotal').innerText = total;
        document.getElementById('kOk').innerText = ok;
        document.getElementById('kDiv').innerText = total - ok;
        document.getElementById('kHealth').innerText = total > 0 ? ((ok / total) * 100).toFixed(1) + "%" : "--";
    }

    function logout() { localStorage.clear(); location.reload(); }

    window.onload = () => {
        fetchMetabase();
        const savedUser = localStorage.getItem('vsm_user');
        if(savedUser) {
            dbPlan = JSON.parse(localStorage.getItem('vsm_conc_data') || "[]");
            showDashboard(savedUser);
            if(dbPlan.length > 0) {
                document.getElementById('upPlan').classList.add('success');
                document.getElementById('txtPlan').innerHTML = `<b style="color:var(--accent-neon)">âœ“ ${dbPlan.length} LOJAS RECUPERADAS</b>`;
                document.getElementById('filterBar').style.display = 'flex';
                document.getElementById('exportBtn').style.display = "block";
            }
        }
    };

    function exportExcel() {
        const table = document.querySelector("table");
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, "Relatorio_Conciliacao_VSM.xlsx");
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSM | Galaxy Pro Persistence</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-galaxy: #020205;
            --accent-blue: #3b82f6;
            --accent-cyan: #00f2ff;
            --accent-pink: #ff007f;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --glass: rgba(15, 15, 25, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-galaxy); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }

        .galaxy-web { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(255, 0, 127, 0.1) 0%, transparent 50%); }
        .stars-layer { position: fixed; inset: 0; z-index: -1; background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.4; animation: drift 120s linear infinite; }
        @keyframes drift { from { background-position: 0 0; } to { background-position: 1000px 1000px; } }

        #welcome-screen { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: var(--bg-galaxy); transition: all 0.5s; }
        .login-glass-card { width: 100%; max-width: 420px; padding: 50px; background: var(--glass); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 40px; text-align: center; }
        .login-logo-orb { width: 85px; height: 85px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); border-radius: 24px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 900; box-shadow: 0 0 40px rgba(59, 130, 246, 0.4); }
        
        .wrapper { max-width: 1400px; margin: 0 auto; padding: 40px; display: none; opacity: 0; transition: opacity 0.5s; }
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 24px; padding: 25px; transition: 0.3s; }
        
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .drop-zone { cursor: pointer; border: 2px dashed rgba(255,255,255,0.1); border-radius: 24px; padding: 30px; text-align: center; transition: 0.3s; }
        .drop-zone.active { border-color: var(--accent-cyan); background: rgba(0, 242, 255, 0.1); border-style: solid; }

        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .number { font-size: 2.5rem; font-weight: 800; }

        .filter-bar { display: flex; gap: 15px; margin-bottom: 25px; background: var(--glass); padding: 15px; border-radius: 18px; border: 1px solid var(--glass-border); align-items: center; }
        .search-field { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 1rem; }
        
        .btn-filter { padding: 10px 25px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text-secondary); cursor: pointer; font-weight: 600; }
        .btn-filter.active { background: var(--accent-blue); color: white; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        th { padding: 15px 25px; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; text-align: left; }
        td { padding: 20px 25px; background: rgba(255,255,255,0.03); border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); font-size: 0.9rem; }
        td:first-child { border-radius: 15px 0 0 15px; border-left: 1px solid var(--glass-border); }
        td:last-child { border-radius: 0 15px 15px 0; border-right: 1px solid var(--glass-border); }

        .tag { padding: 6px 14px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; }
        .tag-ok { background: rgba(0, 242, 255, 0.1); color: var(--accent-cyan); }
        .tag-err { background: rgba(255, 0, 127, 0.1); color: var(--accent-pink); }
        
        .btn-launch { padding: 12px 25px; border-radius: 12px; border: none; background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan)); color: white; font-weight: 800; cursor: pointer; }
        .btn-danger { background: transparent; border: 1px solid var(--accent-pink); color: var(--accent-pink); padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-left: 10px; transition: 0.3s; }
        .btn-danger:hover { background: var(--accent-pink); color: white; }
    </style>
</head>
<body>

<div class="galaxy-web"></div>
<div class="stars-layer"></div>

<div id="welcome-screen">
    <div class="login-glass-card">
        <div class="login-logo-orb">V</div>
        <h1>VSM CONCILIADOR</h1>
        <p style="color: var(--text-secondary); margin-bottom: 35px;">SISTEMA DE AUDITORIA PERSISTENTE</p>
        <input type="text" id="userName" style="width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); padding:18px; border-radius:18px; color:white; text-align:center; margin-bottom:20px;" placeholder="NOME DO AUDITOR">
        <button class="btn-launch" style="width:100%" onclick="startSession()">Acessar Painel</button>
    </div>
</div>

<div class="wrapper" id="main-app">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
        <div>
            <h1 style="font-size: 1.6rem; font-weight: 800;">VSM <span style="color: var(--accent-cyan);">.INFO</span></h1>
            <p id="userDisplay" style="font-size: 0.8rem; color: var(--text-secondary);"></p>
        </div>
        <div style="display: flex; align-items: center;">
            <button class="btn-launch" onclick="exportExcel()">EXPORTAR EXCEL</button>
            <button class="btn-danger" onclick="limparDados()">LIMPAR DADOS</button>
            <button class="btn-danger" style="border-color: #555; color: #888;" onclick="logoff()">LOGOFF</button>
        </div>
    </header>

    <div class="upload-grid">
        <div class="drop-zone" id="boxSql" onclick="document.getElementById('inSql').click()">
            <h3 style="color: var(--accent-cyan);">TIPO 01: METABASE</h3>
            <p id="txtSql">Carregar CSV</p>
            <input type="file" id="inSql" hidden accept=".csv">
        </div>
        <div class="drop-zone" id="boxSitef" onclick="document.getElementById('inSitef').click()">
            <h3 style="color: var(--accent-pink);">TIPO 02: SITEF</h3>
            <p id="txtSitef">Carregar Excel (I e J)</p>
            <input type="file" id="inSitef" hidden accept=".xlsx, .xls">
        </div>
    </div>

    <div class="kpi-grid">
        <div class="card"><small>TOTAL SITEF</small><div class="number" id="kTotal">0</div></div>
        <div class="card"><small style="color:var(--accent-cyan)">CONFORMES</small><div class="number" id="kOk" style="color: var(--accent-cyan)">0</div></div>
        <div class="card"><small style="color:var(--accent-pink)">DIVERGENTES</small><div class="number" id="kDiv" style="color: var(--accent-pink)">0</div></div>
        <div class="card"><small>SAÚDE</small><div class="number" id="kHealth">0%</div></div>
    </div>

    <div class="filter-bar">
        <input type="text" class="search-field" id="searchInput" placeholder="Buscar loja..." onkeyup="render()">
        <button class="btn-filter active" id="btnAll" onclick="setFilter('all')">Todos</button>
        <button class="btn-filter" id="btnDiv" onclick="setFilter('div')">Ver Divergentes</button>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>CNPJ (COL. I)</th>
                    <th>NOME (COL. J)</th>
                    <th>STATUS VSM</th>
                    <th>DIAGNÓSTICO</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let dbMetabase = new Set();
    let dbSitef = [];
    let filterType = 'all';

    // AO CARREGAR A PÁGINA
    window.onload = function() {
        const savedUser = localStorage.getItem('vsm_user');
        const savedMetabase = localStorage.getItem('vsm_dbMetabase');
        const savedSitef = localStorage.getItem('vsm_dbSitef');

        if (savedUser) {
            document.getElementById('userName').value = savedUser;
            startSession(true); // Entra direto se já logou antes
        }

        if (savedMetabase) {
            const arr = JSON.parse(savedMetabase);
            dbMetabase = new Set(arr);
            document.getElementById('boxSql').classList.add('active');
            document.getElementById('txtSql').innerText = "✓ Dados SQL Carregados";
        }

        if (savedSitef) {
            dbSitef = JSON.parse(savedSitef);
            document.getElementById('boxSitef').classList.add('active');
            document.getElementById('txtSitef').innerText = "✓ Dados SiTef Carregados";
        }
        
        render();
    };

    function startSession(isAuto = false) {
        const name = document.getElementById('userName').value;
        if(!name) return;
        localStorage.setItem('vsm_user', name);
        document.getElementById('userDisplay').innerText = "AUDITOR: " + name.toUpperCase();
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('main-app').style.opacity = '1';
    }

    // PROCESSAR METABASE
    document.getElementById('inSql').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (f) => {
            const lines = f.target.result.split('\n');
            dbMetabase.clear();
            lines.forEach(l => {
                const c = l.split(',')[0].replace(/\D/g, '').trim();
                if(c.length >= 11) dbMetabase.add(c);
            });
            localStorage.setItem('vsm_dbMetabase', JSON.stringify(Array.from(dbMetabase)));
            document.getElementById('boxSql').classList.add('active');
            render();
        };
        reader.readAsText(e.target.files[0], 'ISO-8859-1');
    };

    // PROCESSAR SITEF
    document.getElementById('inSitef').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (f) => {
            const data = new Uint8Array(f.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});

            let map = new Map();
            rows.forEach((row, i) => {
                if(i === 0) return;
                let cnpj = String(row[8] || "").replace(/\D/g, '');
                let nome = String(row[9] || "").toUpperCase();
                if(cnpj.length >= 11) map.set(cnpj, { cnpj, nome });
            });

            dbSitef = Array.from(map.values());
            localStorage.setItem('vsm_dbSitef', JSON.stringify(dbSitef));
            document.getElementById('boxSitef').classList.add('active');
            render();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function render() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        let ok = 0;

        dbSitef.forEach(item => {
            const exists = dbMetabase.has(item.cnpj);
            if(exists) ok++;
            if (filterType === 'div' && exists) return;
            if (search && !item.nome.toLowerCase().includes(search) && !item.cnpj.includes(search)) return;

            tbody.innerHTML += `
                <tr>
                    <td style="font-family:'JetBrains Mono'; color:var(--accent-cyan); font-weight:bold;">${item.cnpj}</td>
                    <td>${item.nome}</td>
                    <td><span class="tag ${exists ? 'tag-ok' : 'tag-err'}">${exists ? 'ATIVO' : 'AUSENTE'}</span></td>
                    <td style="color:${exists ? 'var(--accent-cyan)' : 'var(--accent-pink)'}; font-weight:800;">
                        ${exists ? '✓ CONFORME' : '⚠ DIVERGENTE'}
                    </td>
                </tr>
            `;
        });

        document.getElementById('kTotal').innerText = dbSitef.length;
        document.getElementById('kOk').innerText = ok;
        document.getElementById('kDiv').innerText = dbSitef.length - ok;
        document.getElementById('kHealth').innerText = dbSitef.length > 0 ? Math.round((ok/dbSitef.length)*100) + "%" : "0%";
    }

    function setFilter(t) {
        filterType = t;
        document.getElementById('btnAll').classList.toggle('active', t === 'all');
        document.getElementById('btnDiv').classList.toggle('active', t === 'div');
        render();
    }

    function limparDados() {
        if(confirm("Deseja apagar todos os dados da auditoria atual?")) {
            localStorage.removeItem('vsm_dbMetabase');
            localStorage.removeItem('vsm_dbSitef');
            location.reload();
        }
    }

    function logoff() {
        if(confirm("Deseja sair e limpar sua sessão?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function exportExcel() {
        XLSX.writeFile(XLSX.utils.table_to_book(document.querySelector("table")), "Auditoria_Sitef.xlsx");
    }
</script>
</body>
</html>
